{% extends "base.html" %}

{% block title %}Team Chat - {{ project.name }}{% endblock %}

{% block content %}
<div class="container py-4 chat-page">

    <style>
        .chat-page .chat-shell {
            border: 1px solid rgba(0,0,0,.08);
            border-radius: 14px;
            overflow: hidden;
            background: #fff;
            box-shadow: 0 10px 24px rgba(16,24,40,.06);
        }

        .chat-page .chat-header {
            padding: 14px 16px;
            background: linear-gradient(135deg, #0d6efd 0%, #4c8dff 100%);
            color: #fff;
        }

        .chat-page .chat-header h2 {
            font-size: 1.15rem;
            margin: 0;
            font-weight: 700;
        }

        .chat-page .chat-window {
            height: 520px;
            overflow-y: auto;
            background:
                radial-gradient(circle at 25px 25px, rgba(13,110,253,.06) 2px, transparent 2.5px) 0 0/28px 28px,
                #f8fafc;
            padding: 16px;
        }

        /* Message row */
        .chat-page .msg {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
            align-items: flex-start;
        }

        /* My messages align right */
        .chat-page .msg.mine {
            flex-direction: row-reverse;
        }

        .chat-page .avatar {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: #e9ecef;
            display: grid;
            place-items: center;
            font-weight: 700;
            color: #495057;
            flex: 0 0 auto;
            border: 1px solid rgba(0,0,0,.06);
        }

        .chat-page .bubble {
            max-width: min(720px, 80%);
            flex: 1 1 auto;
            background: #fff;
            border: 1px solid rgba(0,0,0,.06);
            border-radius: 14px;
            padding: 10px 12px;
        }

        /* Different color for my bubble */
        .chat-page .msg.mine .bubble {
            background: rgba(13,110,253,.10);
            border-color: rgba(13,110,253,.18);
        }

        .chat-page .meta {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 6px;
            align-items: baseline;
        }

        .chat-page .msg.mine .meta {
            flex-direction: row-reverse;
        }

        .chat-page .meta strong {
            font-size: .95rem;
        }

        .chat-page .meta small {
            color: #6c757d;
            white-space: nowrap;
        }

        .chat-page .msg-text {
            margin: 0;
            color: #212529;
            line-height: 1.35rem;
            white-space: pre-wrap;
            overflow-wrap: anywhere;
        }

        .chat-page .attachment {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            padding: 8px 10px;
            border-radius: 12px;
            background: rgba(13,110,253,.06);
            border: 1px solid rgba(13,110,253,.12);
            text-decoration: none;
        }

        .chat-page .attachment:hover {
            background: rgba(13,110,253,.10);
        }

        .chat-page .attachment .filename {
            font-weight: 700;
            color: #0d6efd;
        }

        .chat-page .composer {
            padding: 14px;
            background: #fff;
            border-top: 1px solid rgba(0,0,0,.06);
        }

        .chat-page .composer .form-control {
            border-radius: 12px;
        }

        .chat-page textarea.form-control {
            min-height: 52px;
            max-height: 140px;
            resize: vertical;
        }

        .chat-page .composer-row {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: end;
        }

        .chat-page .attach-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .chat-page .file-input {
            position: absolute;
            left: -9999px;
        }

        .chat-page .attach-btn {
            border-radius: 999px;
        }

        .chat-page .file-chip {
            display: none;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 999px;
            background: #f1f3f5;
            border: 1px solid rgba(0,0,0,.06);
            font-size: .9rem;
        }

        .chat-page .file-chip button {
            border: 0;
            background: transparent;
            padding: 0 2px;
            font-size: 1.1rem;
            line-height: 1;
            color: #6c757d;
        }

        .chat-page .send-btn {
            border-radius: 12px;
            padding-left: 16px;
            padding-right: 16px;
            height: 52px;
            font-weight: 700;
            white-space: nowrap;
        }

        .chat-page .hint {
            color: #6c757d;
            font-size: .9rem;
            margin-top: 8px;
        }
    </style>

    <div class="chat-shell">
        <div class="chat-header">
            <div class="d-flex justify-content-between align-items-end">
                <h2>Team Chat — {{ project.name }}</h2>
                <small>Enter to send • Shift+Enter for new line</small>
            </div>
        </div>

        <!-- Chat Window -->
        <div id="chatWindow" class="chat-window">
            {% for message in messages %}
                <div class="msg {% if message.user == request.user %}mine{% else %}theirs{% endif %}">
                    <div class="avatar" title="{{ message.user.username }}">
                        {{ message.user.get_full_name|default:message.user.username|slice:":1"|upper }}
                    </div>

                    <div class="bubble">
                        <div class="meta">
                            <strong>
                                {% if message.user == request.user %}
                                    You
                                {% else %}
                                    {{ message.user.get_full_name|default:message.user.username }}
                                {% endif %}
                            </strong>
                            <small class="text-muted">{{ message.created_at }}</small>
                        </div>

                        {% if message.text %}
                            <p class="msg-text">{{ message.text }}</p>
                        {% endif %}

                        {% if message.file %}
                            <a href="{{ message.file.url }}" class="attachment" download>
                                <span class="filename">
                                    {{ message.file.name|cut:"chat_resources/" }}
                                </span>
                                <span class="text-muted">Download</span>
                            </a>
                        {% endif %}
                    </div>
                </div>
            {% empty %}
                <p class="text-muted m-0">No messages yet. Start the conversation below.</p>
            {% endfor %}
        </div>

        <!-- Send Message Form -->
        <div class="composer">
            <form id="chatForm" method="post" enctype="multipart/form-data">
                {% csrf_token %}

                <div class="composer-row">
                    <div>
                        {{ form.text.label_tag }}
                        {{ form.text }}
                    </div>

                    <button id="sendBtn" type="submit" class="btn btn-primary send-btn">
                        Send
                    </button>
                </div>

                <div class="attach-row">
                    <input id="fileInput" class="file-input" type="file" name="{{ form.file.name }}" />

                    <button type="button" id="attachBtn" class="btn btn-outline-primary attach-btn">
                        Attach file
                    </button>

                    <div id="fileChip" class="file-chip">
                        <span id="fileName"></span>
                        <button type="button" id="clearFile" aria-label="Remove file">&times;</button>
                    </div>

                    <div class="hint">Tip: Press <strong>Enter</strong> to send, <strong>Shift+Enter</strong> for a new line.</div>
                </div>
            </form>
        </div>
    </div>

    <script>
        (function () {
            const chatWindow = document.getElementById('chatWindow');
            if (chatWindow) chatWindow.scrollTop = chatWindow.scrollHeight;

            const form = document.getElementById('chatForm');
            const sendBtn = document.getElementById('sendBtn');

            // Ensure textarea gets Bootstrap styling even if widget isn't configured
            const textarea = document.querySelector('textarea[name="{{ form.text.name }}"]');
            if (textarea && !textarea.classList.contains('form-control')) textarea.classList.add('form-control');
            if (textarea) textarea.setAttribute('placeholder', 'Write a message…');

            // Enter to send, Shift+Enter to newline
            if (textarea && form) {
                textarea.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        // avoid sending empty message with no file
                        const fileInput = document.getElementById('fileInput');
                        const hasText = textarea.value.trim().length > 0;
                        const hasFile = fileInput && fileInput.files && fileInput.files.length > 0;

                        if (hasText || hasFile) {
                            if (sendBtn) sendBtn.disabled = true; // basic double-submit protection
                            form.submit();
                        }
                    }
                });
            }

            // Custom file attach UI
            const fileInput = document.getElementById('fileInput');
            const attachBtn = document.getElementById('attachBtn');
            const fileChip = document.getElementById('fileChip');
            const fileName = document.getElementById('fileName');
            const clearFile = document.getElementById('clearFile');

            if (attachBtn && fileInput) attachBtn.addEventListener('click', () => fileInput.click());

            function refreshFileChip() {
                if (fileInput.files && fileInput.files.length > 0) {
                    fileChip.style.display = 'inline-flex';
                    fileName.textContent = fileInput.files[0].name;
                } else {
                    fileChip.style.display = 'none';
                    fileName.textContent = '';
                }
            }

            if (fileInput) fileInput.addEventListener('change', refreshFileChip);

            if (clearFile) {
                clearFile.addEventListener('click', () => {
                    fileInput.value = '';
                    refreshFileChip();
                });
            }

            refreshFileChip();
        })();
    </script>

</div>
{% endblock %}